#!/usr/bin/env bash

USERNAME=pachonk
REPO=celebrity-picture-rater

BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != "auto-vuln" ]]; then
  echo 'Only the master branch runs vulnerability autofix'
  exit 1
fi

bundle update loofah

git config --local user.email "alex@piechowski.io" 
git config --local user.name "Alex Piechowski" 
git remote add github https://pachonk:$GITHUB_API_KEY@github.com/pachonk/celebrity-picture-rater.git

git checkout -b loofah-auto

git commit -am "Update loofah to latest version"
git push github loofah-auto

curl --user $GITHUB_API_KEY:x-oauth-basic -d '{"title":"Update Vulnerable Loofah", "head": "loofah-auto", "base": "master"}' -X POST https://api.github.com/repos/pachonk/celebrity-picture-rater/pulls

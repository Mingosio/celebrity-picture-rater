#!/usr/bin/env bash

USERNAME=pachonk
REPO=celebrity-picture-rater

BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != "auto-vuln" ]]; then
  echo 'Only the master branch runs vulnerability autofix'
  exit 1
fi

git config --local user.email "alex@piechowski.io" 
git config --local user.name "Alex Piechowski" 
git remote add github https://pachonk:$GITHUB_API_KEY@github.com/pachonk/celebrity-picture-rater.git

BUNDLE_AUDIT_OUTPUT=`bundle-audit -u`
GEMS_TO_UPDATE=`bundle-audit -u | grep 'Name:' | awk '{print $2}'`

while read -r gem; do
  bundle update $gem
done <<< $GEMS_TO_UPDATE

git checkout -b loofah-auto-test

git commit -am "Update loofah to latest version"

# git push github loofah-auto-test

# curl --user $GITHUB_API_KEY:x-oauth-basic -d '{"title":"Update Vulnerable Loofah", "head": "loofah-auto", "base": "master"}' -X POST https://api.github.com/repos/pachonk/celebrity-picture-rater/pulls

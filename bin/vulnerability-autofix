#!/usr/bin/env bash

USERNAME=pachonk
REPO=celebrity-picture-rater

BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != "master" ]]; then
  echo 'Only the master branch runs vulnerability autofix'
  exit 0
fi

git config --local user.email "alex@piechowski.io" 
git config --local user.name "Alex Piechowski" 
git remote add github https://pachonk:$GITHUB_API_KEY@github.com/$USERNAME/$REPO.git

gem install bundle-audit
BUNDLE_AUDIT_OUTPUT=`bundle-audit -u`
GEMS_TO_UPDATE=`bundle-audit -u | grep 'Name:' | awk '{print $2}'`

while read -r gem; do
  bundle update $gem
done <<< $GEMS_TO_UPDATE

BRANCH_NAME=security-patch-`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 10 | head -n 1`
git checkout -b $BRANCH_NAME

git commit -am "AUTO: Update vulnerable gems to the latest version

bundle-audit output:
--------------------
$BUNDLE_AUDIT_OUTPUT"

git push github $BRANCH_NAME

curl --user $GITHUB_API_KEY:x-oauth-basic -d '{"title":"AUTO: Update Vulnerable gems to the latest version", "head": "'$BRANCH_NAME'", "base": "master"}' -X POST https://api.github.com/repos/$USERNAME/$REPO/pulls
